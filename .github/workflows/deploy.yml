name: CI nginx test

on:
  push:
    paths:
      - index.html

jobs:
  deploy-and-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Save SSH key
        run: |
          echo "${{ secrets.SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Copy files to VM
        run: |
          scp -i key.pem -o StrictHostKeyChecking=no index.html Dockerfile ${{ secrets.VM_USER }}@${{ secrets.VM_IP }}:/home/${{ secrets.VM_USER }}/

      - name: Remote deploy and test
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_IP }} <<'EOF'
            cd /home/${{ secrets.VM_USER }}
            
            echo "üõ†Ô∏è –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞..."
            docker build -t test-nginx .

            echo "üßπ –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)..."
            docker rm -f test-nginx || true

            echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker run -d -p 9889:80 --name test-nginx test-nginx || { echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"; exit 1; }

            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞..."
            sleep 10

            echo "üì• –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP-–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..."
            curl -s -o downloaded.html -w "%{http_code}" http://localhost:9889 > http_code.txt
            code=$(tail -n1 http_code.txt)

            if [[ "$code" != "200" ]]; then
              echo "‚ùå –û—à–∏–±–∫–∞: –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞ $code"
              exit 1
            fi

            echo "üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ md5-—Å—É–º–º..."
            md5sum index.html | cut -d' ' -f1 > original.md5
            md5sum downloaded.html | cut -d' ' -f1 > downloaded.md5

            diff original.md5 downloaded.md5 || { echo "‚ùå MD5 –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç"; exit 1; }

            echo "‚úÖ –í—Å—ë —É—Å–ø–µ—à–Ω–æ. –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
            docker rm -f test-nginx
          EOF
