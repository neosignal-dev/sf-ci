name: CI nginx test

on:
  push:
    paths:
      - index.html

jobs:
  deploy-and-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Save SSH key
        run: |
          echo "${{ secrets.SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Copy files to VM
        run: |
          scp -i key.pem -o StrictHostKeyChecking=no index.html Dockerfile ${{ secrets.VM_USER }}@${{ secrets.VM_IP }}:/home/${{ secrets.VM_USER }}/

      - name: Remote deploy and test (DEBUG)
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_IP }} <<'EOF'
            set -x  # –í–∫–ª—é—á–∏—Ç—å –≤—ã–≤–æ–¥ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥

            cd /home/${{ secrets.VM_USER }}

            echo "üõ† –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞"
            docker build -t test-nginx .

            echo "üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)"
            docker rm -f test-nginx || true

            echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
            docker run -d -p 9889:80 --name test-nginx test-nginx || { echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞"; docker logs test-nginx || true; exit 1; }

            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞"
            sleep 10

            echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker ps -a

            echo "üì• curl-–∑–∞–ø—Ä–æ—Å –∫ nginx"
            curl -v http://localhost:9889 || { echo "‚ùå curl –Ω–µ—É–¥–∞—á–µ–Ω"; exit 1; }

            echo "üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ md5"
            md5sum index.html | cut -d' ' -f1 > original.md5
            curl -s http://localhost:9889 > downloaded.html
            md5sum downloaded.html | cut -d' ' -f1 > downloaded.md5
            diff original.md5 downloaded.md5 || { echo "‚ùå MD5 –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç"; exit 1; }

            # echo "‚úÖ –£—Å–ø–µ—à–Ω–æ. –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
            # docker rm -f test-nginx
          EOF
